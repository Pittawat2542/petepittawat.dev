---
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';
import { getCollection } from 'astro:content';
import PageWithHero from '../../layouts/PageWithHero.astro';
import { getAllSeries } from '../../lib/series';
import { BookOpen, ChevronRight } from 'lucide-astro';
import FormattedDate from '../../components/FormattedDate.astro';

const allPosts = await getCollection('blog');
const allSeries = getAllSeries(allPosts);

// Sort series by the most recent post date
allSeries.sort((a, b) => {
  const latestA = Math.max(...a.posts.map(p => p.data.pubDate.valueOf()));
  const latestB = Math.max(...b.posts.map(p => p.data.pubDate.valueOf()));
  return latestB - latestA;
});
---

<PageWithHero
  title={`${SITE_TITLE} - Series`}
  description={`${SITE_DESCRIPTION} - Explore multi-part blog series`}
  hero={{
    title: 'Blog Series',
    subtitle: 'Multi-part deep dives into various topics. Follow along with structured learning paths and comprehensive guides.',
    page: 'blog'
  }}
>
  <Fragment slot="head" />
  <Fragment slot="after">
    <!-- Actions under hero -->
    <div class="-mt-4 mb-8 flex items-center justify-center">
      <a href="/blog" class="inline-flex items-center gap-2 rounded-xl px-4 py-2.5 text-sm font-medium text-[color:var(--accent)] bg-[color:var(--accent)]/[.12] ring-1 ring-[color:var(--accent)]/40 hover:bg-[color:var(--accent)]/[.18] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
        All posts
        <ChevronRight class="h-4 w-4" />
      </a>
    </div>
  </Fragment>

  <div class="max-w-4xl mx-auto">
    {allSeries.length > 0 ? (
      <div class="grid gap-8">
        {allSeries.map((series) => {
          const firstPost = series.posts[0];
          const lastPost = series.posts[series.posts.length - 1];
          const totalReadingTime = series.posts.reduce((total, post) => {
            const wordCount = (post.body || '').trim().split(/\s+/).length;
            return total + Math.max(1, Math.round(wordCount / 220));
          }, 0);
          
          return (
            <article class="glass-card rounded-2xl border border-border bg-card p-6 md:p-8">
              <div class="flex items-start gap-4">
                <div class="flex-shrink-0 p-3 rounded-xl bg-[color:var(--accent)]/20">
                  <BookOpen class="h-6 w-6 text-[color:var(--accent)]" />
                </div>
                
                <div class="flex-1 min-w-0">
                  <header class="mb-4">
                    <h2 class="text-2xl md:text-3xl font-bold mb-2 text-[color:var(--white)]">
                      {series.title}
                    </h2>
                    
                    {series.description && (
                      <p class="text-[color:var(--white)]/70 text-sm md:text-base leading-relaxed mb-4">
                        {series.description}
                      </p>
                    )}
                    
                    <div class="flex flex-wrap items-center gap-4 text-xs md:text-sm text-[color:var(--white)]/60">
                      <span class="flex items-center gap-1.5">
                        <span class="w-2 h-2 rounded-full bg-[color:var(--accent)]"></span>
                        {series.totalParts} part{series.totalParts !== 1 ? 's' : ''}
                      </span>
                      <span>~{totalReadingTime} min total</span>
                      <span>
                        Last updated <FormattedDate date={lastPost.data.pubDate} />
                      </span>
                    </div>
                  </header>

                  <div class="space-y-3 mb-6">
                    {series.posts.map((post, index) => (
                      <div class="flex items-center gap-3 p-3 rounded-lg border border-[color:var(--white)]/10 hover:border-[color:var(--accent)]/30 hover:bg-[color:var(--accent)]/5 transition-all duration-200">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-[color:var(--accent)]/20 text-[color:var(--accent)] flex items-center justify-center text-sm font-bold">
                          {index + 1}
                        </div>
                        
                        <div class="flex-1 min-w-0">
                          <a 
                            href={`/blog/${post.slug}/`}
                            class="block hover:text-[color:var(--accent)] transition-colors"
                          >
                            <h3 class="font-medium text-sm md:text-base leading-snug mb-1">
                              {post.data.title}
                            </h3>
                            <p class="text-xs text-[color:var(--white)]/50 truncate">
                              <FormattedDate date={post.data.pubDate} />
                            </p>
                          </a>
                        </div>

                        <ChevronRight class="h-4 w-4 text-[color:var(--white)]/30 flex-shrink-0" />
                      </div>
                    ))}
                  </div>

                  <footer class="flex items-center justify-between">
                    <a
                      href={`/blog/${firstPost.slug}/`}
                      class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-[color:var(--accent)] text-[color:var(--bg)] hover:bg-[color:var(--accent)]/90 transition-colors duration-200 text-sm font-medium"
                    >
                      Start reading
                      <ChevronRight class="h-4 w-4" />
                    </a>
                    
                    <div class="flex items-center gap-2 text-xs text-[color:var(--white)]/50">
                      <span>Started</span>
                      <FormattedDate date={firstPost.data.pubDate} />
                    </div>
                  </footer>
                </div>
              </div>
            </article>
          );
        })}
      </div>
    ) : (
      <div class="text-center py-16">
        <div class="w-16 h-16 mx-auto mb-6 rounded-full bg-[color:var(--accent)]/20 flex items-center justify-center">
          <BookOpen class="h-8 w-8 text-[color:var(--accent)]" />
        </div>
        <h2 class="text-2xl font-bold mb-2 text-[color:var(--white)]">No Series Yet</h2>
        <p class="text-[color:var(--white)]/70 mb-6">
          Check back later for multi-part blog series covering various topics in depth.
        </p>
        <a 
          href="/blog"
          class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-[color:var(--accent)] text-[color:var(--bg)] hover:bg-[color:var(--accent)]/90 transition-colors duration-200 text-sm font-medium"
        >
          Browse all posts
          <ChevronRight class="h-4 w-4" />
        </a>
      </div>
    )}
  </div>
</PageWithHero>
