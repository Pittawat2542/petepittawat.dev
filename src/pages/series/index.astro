---
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';
import { getCollection } from 'astro:content';
import PageWithHero from '../../layouts/PageWithHero.astro';
import { getAllSeries } from '../../lib/series';
import { BookOpen, ChevronRight } from 'lucide-astro';
import FormattedDate from '../../components/content/FormattedDate';

const allPosts = await getCollection('blog');
const allSeries = getAllSeries(allPosts);

// Sort series by the most recent post date
allSeries.sort((a, b) => {
  const latestA = Math.max(...a.posts.map(p => p.data.pubDate.valueOf()));
  const latestB = Math.max(...b.posts.map(p => p.data.pubDate.valueOf()));
  return latestB - latestA;
});
---

<PageWithHero
  title={`${SITE_TITLE} - Series`}
  description={`${SITE_DESCRIPTION} - Explore multi-part blog series`}
  hero={{
    title: 'Blog Series',
    subtitle:
      'Multi-part deep dives into various topics. Follow along with structured learning paths and comprehensive guides.',
    page: 'blog',
  }}
>
  <Fragment slot="head"></Fragment>
  <Fragment slot="after">
    <!-- Actions under hero -->
    <div class="-mt-4 mb-8 flex items-center justify-center">
      <a
        href="/blog"
        class="focus-visible:ring-ring inline-flex items-center gap-2 rounded-xl bg-[color:var(--accent)]/[.12] px-4 py-2.5 text-sm font-medium text-[color:var(--accent)] ring-1 ring-[color:var(--accent)]/40 hover:bg-[color:var(--accent)]/[.18] focus-visible:ring-2 focus-visible:outline-none"
      >
        All posts
        <ChevronRight class="h-4 w-4" />
      </a>
    </div>
  </Fragment>

  <div class="mx-auto max-w-4xl">
    {
      allSeries.length > 0 ? (
        <div class="grid gap-8">
          {allSeries.map(series => {
            const firstPost = series.posts[0];
            const lastPost = series.posts[series.posts.length - 1];
            const totalReadingTime = series.posts.reduce((total, post) => {
              const wordCount = (post.body || '').trim().split(/\s+/).length;
              return total + Math.max(1, Math.round(wordCount / 220));
            }, 0);

            return (
              <article class="glass-card border-border bg-card rounded-2xl border p-6 md:p-8">
                <div class="flex items-start gap-4">
                  <div class="flex-shrink-0 rounded-xl bg-[color:var(--accent)]/20 p-3">
                    <BookOpen class="h-6 w-6 text-[color:var(--accent)]" />
                  </div>

                  <div class="min-w-0 flex-1">
                    <header class="mb-4">
                      <h2 class="mb-2 text-2xl font-bold text-[color:var(--white)] md:text-3xl">
                        {series.title}
                      </h2>

                      {series.description && (
                        <p class="mb-4 text-sm leading-relaxed text-[color:var(--white)]/70 md:text-base">
                          {series.description}
                        </p>
                      )}

                      <div class="flex flex-wrap items-center gap-4 text-xs text-[color:var(--white)]/60 md:text-sm">
                        <span class="flex items-center gap-1.5">
                          <span class="h-2 w-2 rounded-full bg-[color:var(--accent)]" />
                          {series.totalParts} part{series.totalParts !== 1 ? 's' : ''}
                        </span>
                        <span>~{totalReadingTime} min total</span>
                        <span>
                          Last updated {lastPost && <FormattedDate date={lastPost.data.pubDate} />}
                        </span>
                      </div>
                    </header>

                    <div class="mb-6 space-y-3">
                      {series.posts.map((post, index) => (
                        <div class="flex items-center gap-3 rounded-lg border border-[color:var(--white)]/10 p-3 transition-all duration-200 hover:border-[color:var(--accent)]/30 hover:bg-[color:var(--accent)]/5">
                          <div class="flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-[color:var(--accent)]/20 text-sm font-bold text-[color:var(--accent)]">
                            {index + 1}
                          </div>

                          <div class="min-w-0 flex-1">
                            <a
                              href={`/blog/${String(post.slug)}/`}
                              class="block transition-colors hover:text-[color:var(--accent)]"
                            >
                              <h3 class="mb-1 text-sm leading-snug font-medium md:text-base">
                                {post.data.title}
                              </h3>
                              <p class="truncate text-xs text-[color:var(--white)]/50">
                                <FormattedDate date={post.data.pubDate} />
                              </p>
                            </a>
                          </div>

                          <ChevronRight class="h-4 w-4 flex-shrink-0 text-[color:var(--white)]/30" />
                        </div>
                      ))}
                    </div>

                    <footer class="flex items-center justify-between">
                      <a
                        href={firstPost ? `/blog/${String(firstPost.slug)}/` : '#'}
                        class="inline-flex items-center gap-2 rounded-lg bg-[color:var(--accent)] px-4 py-2 text-sm font-medium text-[color:var(--bg)] transition-colors duration-200 hover:bg-[color:var(--accent)]/90"
                      >
                        Start reading
                        <ChevronRight class="h-4 w-4" />
                      </a>

                      <div class="flex items-center gap-2 text-xs text-[color:var(--white)]/50">
                        <span>Started</span>
                        {firstPost && <FormattedDate date={firstPost.data.pubDate} />}
                      </div>
                    </footer>
                  </div>
                </div>
              </article>
            );
          })}
        </div>
      ) : (
        <div class="py-16 text-center">
          <div class="mx-auto mb-6 flex h-16 w-16 items-center justify-center rounded-full bg-[color:var(--accent)]/20">
            <BookOpen class="h-8 w-8 text-[color:var(--accent)]" />
          </div>
          <h2 class="mb-2 text-2xl font-bold text-[color:var(--white)]">No Series Yet</h2>
          <p class="mb-6 text-[color:var(--white)]/70">
            Check back later for multi-part blog series covering various topics in depth.
          </p>
          <a
            href="/blog"
            class="inline-flex items-center gap-2 rounded-lg bg-[color:var(--accent)] px-4 py-2 text-sm font-medium text-[color:var(--bg)] transition-colors duration-200 hover:bg-[color:var(--accent)]/90"
          >
            Browse all posts
            <ChevronRight class="h-4 w-4" />
          </a>
        </div>
      )
    }
  </div>
</PageWithHero>
