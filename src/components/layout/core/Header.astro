---
import SiteLogo from '../../header/SiteLogo.astro';
import Navigation from '../../header/Navigation.tsx';
import SearchButton from '../../header/SearchButton.astro';
import MobileMenu from '../../header/MobileMenu.astro';

// Normalize current path to work with both `build.format: "file"` (e.g. "/talks.html")
// and directory-style paths (e.g. "/talks/"). This ensures active nav detection works.
let current =
  Astro.url.pathname
    // Map "/index.html" to root
    .replace(/\/index\.html$/, '/')
    // Strip any .html extension (e.g., "/talks.html" -> "/talks")
    .replace(/\.html$/, '')
    // Remove any trailing slashes
    .replace(/\/+$/, '') || '/';
---

<header
  class="site-header"
  style="top: max(env(safe-area-inset-top), 1rem); view-transition-name: site-header;"
>
  <div class="site-header__container" id="site-nav-shell" data-scrolled="false">
    <div class="site-header__glow" aria-hidden="true"></div>
    <div class="site-header__sheen" aria-hidden="true"></div>
    <nav id="site-nav" aria-label="Primary" data-scrolled="false" class="site-header__nav">
      <div class="site-header__brand">
        <SiteLogo />
      </div>

      <Navigation currentPath={current} />

      <div class="site-header__actions">
        <SearchButton variant="desktop" />
        <div class="site-header__divider" aria-hidden="true"></div>
        <SearchButton variant="mobile" />
        <MobileMenu currentPath={current} />
      </div>
    </nav>
  </div>
</header>

<style>
  .site-header {
    position: fixed;
    inset-inline: 0;
    z-index: 50;
    display: flex;
    justify-content: center;
    pointer-events: none;
    padding-inline: clamp(0.75rem, 4vw, 2rem);
  }

  .site-header__container {
    position: relative;
    width: min(100%, 76rem);
    pointer-events: auto;
    border-radius: 999px;
    padding: 1.5px;
    background: linear-gradient(
      135deg,
      rgba(255, 255, 255, 0.12),
      rgba(59, 130, 246, 0.08) 45%,
      rgba(236, 72, 153, 0.1)
    );
    transition:
      transform 360ms cubic-bezier(0.22, 0.61, 0.36, 1),
      filter 360ms ease,
      opacity 320ms ease,
      background 360ms ease;
  }

  .site-header__container[data-scrolled='false'] {
    background: linear-gradient(
      135deg,
      rgba(255, 255, 255, 0.16),
      rgba(59, 130, 246, 0.1) 45%,
      rgba(236, 72, 153, 0.14)
    );
  }

  .site-header__container[data-scrolled='true'] {
    background: linear-gradient(135deg, rgba(10, 15, 28, 0.86), rgba(11, 18, 33, 0.9));
    box-shadow: 0 32px 64px -36px rgba(2, 7, 16, 0.72);
  }

  .site-header__container::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    border: 1px solid rgba(255, 255, 255, 0.14);
    pointer-events: none;
    opacity: 0.35;
  }

  .site-header__glow {
    position: absolute;
    inset: -25% -20%;
    border-radius: inherit;
    background:
      radial-gradient(circle at 15% 20%, rgba(59, 130, 246, 0.4), transparent 70%),
      radial-gradient(circle at 85% 80%, rgba(236, 72, 153, 0.5), transparent 70%);
    filter: blur(120px);
    opacity: 0.65;
    transition: opacity 400ms ease;
  }

  .site-header__sheen {
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: linear-gradient(120deg, rgba(255, 255, 255, 0.22), rgba(255, 255, 255, 0));
    opacity: 0.35;
    mask-image: linear-gradient(90deg, rgba(0, 0, 0, 0.65), transparent 80%);
    pointer-events: none;
    transition: opacity 360ms ease;
  }

  .site-header__nav {
    position: relative;
    display: flex;
    align-items: center;
    gap: clamp(0.4rem, 2vw, 1.2rem);
    padding: clamp(0.55rem, 1.6vw, 0.9rem) clamp(0.9rem, 1.8vw, 1.35rem);
    border-radius: inherit;
    background: linear-gradient(135deg, rgba(9, 15, 26, 0.62), rgba(7, 12, 24, 0.54));
    border: 1px solid rgba(255, 255, 255, 0.06);
    box-shadow:
      0 24px 60px -38px rgba(3, 10, 26, 0.75),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    overflow: hidden;
    isolation: isolate;
    transition:
      background-color 320ms ease,
      border-color 320ms ease,
      box-shadow 320ms ease,
      transform 360ms cubic-bezier(0.22, 0.61, 0.36, 1);
  }

  .site-header__nav[data-scrolled='false'] {
    transform: translateY(0);
  }

  .site-header__nav[data-scrolled='true'] {
    background: linear-gradient(135deg, rgba(8, 13, 26, 0.94), rgba(9, 16, 32, 0.96));
    border-color: rgba(255, 255, 255, 0.16);
    box-shadow:
      0 28px 70px -40px rgba(5, 10, 24, 0.88),
      inset 0 1px 0 rgba(255, 255, 255, 0.12);
    transform: translateY(-2px) scale(0.998);
  }

  .site-header__nav::before {
    content: '';
    position: absolute;
    inset: -40% -10% 50% -10%;
    background: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.14), transparent 70%);
    opacity: 0.35;
    transform: translateY(-30%);
    transition:
      opacity 360ms ease,
      transform 360ms ease;
  }

  .site-header__nav[data-scrolled='true']::before {
    opacity: 0.2;
    transform: translateY(-10%);
  }

  .site-header__brand {
    display: flex;
    align-items: center;
    min-width: 0;
  }

  .site-header__actions {
    display: flex;
    align-items: center;
    gap: clamp(0.35rem, 1.2vw, 0.65rem);
    margin-left: auto;
  }

  .site-header__actions .search-trigger--primary {
    display: none;
  }

  .site-header__actions .search-trigger {
    background: rgba(14, 25, 45, 0.58);
    border-color: rgba(255, 255, 255, 0.18);
    color: rgba(240, 245, 255, 0.9);
    box-shadow: 0 22px 48px -28px rgba(3, 12, 24, 0.85);
  }

  .site-header__actions .search-trigger:hover {
    border-color: rgba(255, 255, 255, 0.32);
    color: rgba(255, 255, 255, 0.98);
  }

  .site-header__actions .search-trigger--icon {
    padding: 0.6rem;
  }

  .site-header__actions .search-trigger svg {
    width: 18px;
    height: 18px;
  }

  .site-header__actions .menu-toggle {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2.6rem;
    height: 2.6rem;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.16);
    background: rgba(12, 22, 38, 0.55);
    color: rgba(248, 250, 252, 0.9);
    transition:
      transform 300ms ease,
      border-color 260ms ease,
      background-color 260ms ease;
  }

  .site-header__actions .menu-toggle:hover,
  .site-header__actions .menu-toggle:focus-visible {
    border-color: rgba(255, 255, 255, 0.32);
    background: color-mix(in oklab, rgba(59, 130, 246, 0.22) 60%, rgba(14, 22, 38, 0.65));
    transform: translateY(-1px);
  }

  .site-header__actions .menu-toggle:focus-visible {
    box-shadow:
      0 0 0 2px rgba(255, 255, 255, 0.2),
      0 0 0 5px rgba(125, 211, 252, 0.35);
  }

  .site-header__actions .menu-toggle__icon span {
    height: 2px;
    background: currentColor;
  }

  .site-header__divider {
    display: none;
    width: 1px;
    height: 1.75rem;
    background: linear-gradient(180deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    opacity: 0.55;
  }

  .site-header__container[data-scrolled='true'] .site-header__glow {
    opacity: 0.45;
  }

  .site-header__container[data-scrolled='true'] .site-header__sheen {
    opacity: 0.25;
  }

  .site-header__nav[data-scrolled='true'] .site-header__actions .search-trigger {
    border-color: rgba(255, 255, 255, 0.22);
  }

  .site-nav__links {
    display: none;
    align-items: center;
    gap: clamp(0.25rem, 1vw, 0.6rem);
    margin-left: clamp(0.75rem, 2vw, 1.5rem);
  }

  .site-nav__links .nav-link-root {
    position: relative;
    padding-inline: clamp(1.1rem, 2vw, 1.35rem);
    padding-block: clamp(0.65rem, 1.4vw, 0.75rem);
    font-size: 0.92rem;
    text-transform: none;
    letter-spacing: 0.012em;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.08);
    color: rgba(248, 250, 252, 0.78);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    overflow: hidden;
  }

  .site-nav__links .nav-link-root:hover,
  .site-nav__links .nav-link-root:focus-visible {
    border-color: rgba(255, 255, 255, 0.18);
    color: rgba(255, 255, 255, 0.95);
  }

  .site-nav__links .nav-link--idle .nav-link__overlay {
    opacity: 0;
  }

  .site-nav__links .nav-link-root:hover .nav-link__overlay,
  .site-nav__links .nav-link-root:focus-visible .nav-link__overlay {
    opacity: 1;
    transform: scale(1.05);
  }

  .site-nav__links .nav-link__overlay {
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background:
      radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.18), transparent 60%),
      radial-gradient(circle at 80% 80%, rgba(236, 72, 153, 0.18), transparent 60%),
      linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0));
    transition:
      opacity 260ms ease,
      transform 300ms ease;
    opacity: 0;
    pointer-events: none;
    transform: scale(1.02);
  }

  .site-nav__links .nav-link__icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 1.6rem;
    width: 1.6rem;
    border-radius: 0.9rem;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.08);
    color: rgba(248, 250, 252, 0.75);
    transition: all 280ms ease;
  }

  .site-nav__links .nav-link__icon--idle {
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
  }

  .site-nav__links .nav-link__icon--active {
    background: color-mix(in oklab, rgba(59, 130, 246, 0.35) 60%, rgba(103, 232, 249, 0.25));
    border-color: color-mix(in oklab, rgba(59, 130, 246, 0.65) 60%, rgba(236, 72, 153, 0.55));
    color: rgba(240, 248, 255, 0.95);
    box-shadow: 0 0 16px rgba(94, 234, 212, 0.35);
  }

  .site-nav__links .nav-link--active {
    border-color: color-mix(in oklab, rgba(59, 130, 246, 0.35) 70%, rgba(236, 72, 153, 0.35));
    background: color-mix(in oklab, rgba(59, 130, 246, 0.22) 65%, rgba(236, 72, 153, 0.18));
    color: rgba(255, 255, 255, 0.96);
    box-shadow:
      0 18px 36px -28px rgba(7, 15, 30, 0.85),
      inset 0 1px 0 rgba(255, 255, 255, 0.18);
  }

  .site-nav__links .nav-link--active .nav-link__overlay {
    opacity: 1;
    transform: scale(1.03);
  }

  .site-nav__links .nav-link:hover .nav-link__icon--idle,
  .site-nav__links .nav-link:focus-visible .nav-link__icon--idle {
    color: rgba(255, 255, 255, 0.95);
    background: color-mix(in oklab, rgba(59, 130, 246, 0.18) 60%, rgba(236, 72, 153, 0.12));
    border-color: rgba(255, 255, 255, 0.24);
    box-shadow: 0 0 18px rgba(79, 70, 229, 0.28);
  }

  .site-nav__links .nav-link__label {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
  }

  .site-nav__links .nav-link__pulse {
    display: block;
    width: 6px;
    height: 6px;
    border-radius: 999px;
    background: currentColor;
    transform: scale(0);
    opacity: 0;
    transition:
      transform 240ms ease,
      opacity 240ms ease;
  }

  .site-nav__links .nav-link[data-active='true'] .nav-link__pulse {
    transform: scale(1);
    opacity: 1;
  }

  @media (min-width: 768px) {
    .site-nav__links {
      display: flex;
    }
    .site-header__divider {
      display: block;
    }
    .site-header__actions .search-trigger--primary {
      display: inline-flex;
    }
    .site-header__actions .search-trigger--icon {
      display: none;
    }
    .site-header__actions {
      gap: clamp(0.45rem, 1.6vw, 0.9rem);
    }
  }

  @media (max-width: 639px) {
    .site-header__nav {
      padding-inline: 0.85rem;
    }
    .site-header__brand {
      flex: 1 1 auto;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .site-header__container,
    .site-header__glow,
    .site-header__sheen,
    .site-header__nav,
    .site-header__nav::before,
    .site-nav__links .nav-link__icon {
      transition: none !important;
    }
  }
</style>

<script>
  import '../scripts/components/header.ts';
</script>
