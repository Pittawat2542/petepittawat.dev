---
import SiteLogo from '../../header/SiteLogo.astro';
import Navigation from '../../header/Navigation.tsx';
import SearchButton from '../../header/SearchButton.astro';
import MobileMenu from '../../header/MobileMenu.astro';

// Normalize current path to work with both `build.format: "file"` (e.g. "/talks.html")
// and directory-style paths (e.g. "/talks/"). This ensures active nav detection works.
let current = Astro.url.pathname
  // Map "/index.html" to root
  .replace(/\/index\.html$/, '/')
  // Strip any .html extension (e.g., "/talks.html" -> "/talks")
  .replace(/\.html$/, '')
  // Remove any trailing slashes
  .replace(/\/+$/, '') || '/';
---

<header class="fixed inset-x-0 z-50" style="top: max(env(safe-area-inset-top), 1rem); view-transition-name: site-header;">
  <div class="mx-auto w-full md:w-fit max-w-[min(92vw,72rem)]">
    <div class="relative block md:inline-flex w-full md:w-auto rounded-full p-[1px]
                data-[scrolled=false]:bg-transparent data-[scrolled=true]:bg-gradient-to-r from-[color:var(--white)]/18 via-transparent to-[color:var(--white)]/18">
      <div class="relative rounded-[inherit] overflow-hidden
                  data-[scrolled=false]:bg-transparent data-[scrolled=true]:bg-[color:var(--black-nav)]/75 data-[scrolled=true]:supports-[backdrop-filter]:bg-[color:var(--black-nav)]/55 data-[scrolled=true]:backdrop-blur-xl">
        <nav id="site-nav" aria-label="Primary" data-scrolled="false"
             class="flex relative z-0 w-full items-center justify-between md:justify-start gap-1 rounded-[inherit] border border-transparent
                    bg-transparent supports-[backdrop-filter]:bg-transparent
                    backdrop-blur-none shadow-none
                    transition-[background-color,box-shadow,transform,border-color,backdrop-filter] duration-300 ease-out
                    data-[scrolled=false]:border-transparent
                    data-[scrolled=false]:bg-transparent data-[scrolled=false]:supports-[backdrop-filter]:bg-transparent
                    data-[scrolled=false]:backdrop-blur-none
                    data-[scrolled=true]:border-transparent
                    data-[scrolled=true]:bg-transparent data-[scrolled=true]:supports-[backdrop-filter]:bg-transparent
                    data-[scrolled=true]:backdrop-blur-2xl data-[scrolled=true]:shadow-[0_28px_60px_-28px_rgba(3,7,15,0.88)]
                    overflow-x-auto overscroll-x-contain scrollbar-none
                    snap-x snap-proximity md:snap-none p-2">
        
        <SiteLogo />

        <!-- Desktop nav -->
        <Navigation currentPath={current} />

        <!-- Actions -->
        <div class="ml-2 md:ml-3 flex items-center gap-1">
          <!-- Progressive Search: load React modal on demand -->
          <SearchButton variant="desktop" />
          <SearchButton variant="mobile" />
          <!-- Mobile menu toggle -->
          <MobileMenu currentPath={current} />
        </div>
        </nav>
      </div>
    </div>
  </div>
</header>

<style>
  @import '../styles/components/header.css';
</style>

<script>
  import '../scripts/components/header.ts';
</script>
